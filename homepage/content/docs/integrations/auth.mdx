---
title: auth
---

# ç”¨æˆ·è®¤è¯é›†æˆ

ç”¨æˆ·è®¤è¯æ˜¯å¤§å¤šæ•° SaaS åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ã€‚Vibe CLI æ”¯æŒå¤šç§ä¸»æµçš„è®¤è¯æœåŠ¡æä¾›å•†ï¼Œè®©ä½ å¯ä»¥å¿«é€Ÿä¸ºåº”ç”¨æ·»åŠ ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™ç®¡ç†ç­‰åŠŸèƒ½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# äº¤äº’å¼å®‰è£…è®¤è¯é›†æˆ
vibe install auth

# ç›´æ¥æŒ‡å®šæä¾›å•†
vibe install auth --provider=clerk
```

## ğŸ“¦ æ”¯æŒçš„æä¾›å•†

### Clerk - ç°ä»£åŒ–è®¤è¯æœåŠ¡

**ç‰¹ç‚¹ï¼š**

- ğŸ¨ å¼€ç®±å³ç”¨çš„ UI ç»„ä»¶
- ğŸ” æ”¯æŒå¤šç§ç¤¾äº¤ç™»å½•
- ğŸ“± å¤šå› ç´ è®¤è¯ (MFA)
- ğŸ‘¥ ç”¨æˆ·ç®¡ç†é¢æ¿
- ğŸŒ å›½é™…åŒ–æ”¯æŒ

**å®‰è£…ï¼š**

```bash
vibe install auth --provider=clerk
```

**é…ç½®ç¤ºä¾‹ï¼š**

```bash
? æ˜¯å¦å¯ç”¨ç¤¾äº¤ç™»å½•: Yes
? é€‰æ‹©ç¤¾äº¤ç™»å½•å¹³å°: Google, GitHub, Apple
? æ˜¯å¦å¯ç”¨å¤šå› ç´ è®¤è¯: Yes
? è‡ªå®šä¹‰åŸŸå (å¯é€‰): auth.myapp.com
```

### NextAuth - Next.js å®˜æ–¹æ–¹æ¡ˆ

**ç‰¹ç‚¹ï¼š**

- âš¡ Next.js æ·±åº¦é›†æˆ
- ğŸ”§ é«˜åº¦å¯å®šåˆ¶
- ğŸ›¡ï¸ å®‰å…¨æ€§ä¼˜å…ˆ
- ğŸ“š ä¸°å¯Œçš„æä¾›å•†æ”¯æŒ
- ğŸ—„ï¸ å¤šç§æ•°æ®åº“æ”¯æŒ

**å®‰è£…ï¼š**

```bash
vibe install auth --provider=nextauth
```

**é…ç½®ç¤ºä¾‹ï¼š**

```bash
? é€‰æ‹©è®¤è¯æä¾›å•†: Google, GitHub, Discord
? é€‰æ‹©æ•°æ®åº“: PostgreSQL (Supabase)
? æ˜¯å¦å¯ç”¨é‚®ç®±éªŒè¯: Yes
? JWT å¯†é’¥ç­–ç•¥: Auto-generate
```

### Supabase Auth - å¼€æºè§£å†³æ–¹æ¡ˆ

**ç‰¹ç‚¹ï¼š**

- ğŸ†“ å¼€æºå…è´¹
- ğŸ—„ï¸ ä¸æ•°æ®åº“æ·±åº¦é›†æˆ
- ğŸ“§ å†…ç½®é‚®ç®±éªŒè¯
- ğŸ”‘ è¡Œçº§å®‰å…¨ (RLS)
- ğŸ“± ç§»åŠ¨ç«¯æ”¯æŒ

**å®‰è£…ï¼š**

```bash
vibe install auth --provider=supabase
```

**é…ç½®ç¤ºä¾‹ï¼š**

```bash
? Supabase é¡¹ç›® URL: https://xxx.supabase.co
? æ˜¯å¦å¯ç”¨ç¤¾äº¤ç™»å½•: Yes
? é€‰æ‹©ç¤¾äº¤ç™»å½•å¹³å°: Google, GitHub
? æ˜¯å¦å¯ç”¨é‚®ç®±ç¡®è®¤: Yes
```

## ğŸ› ï¸ å®‰è£…åé…ç½®

### 1. ç¯å¢ƒå˜é‡è®¾ç½®

æ ¹æ®é€‰æ‹©çš„æä¾›å•†ï¼Œéœ€è¦é…ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡ï¼š

#### Clerk

```bash
# .env.local
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
CLERK_SECRET_KEY=sk_test_xxx
```

#### NextAuth

```bash
# .env.local
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key
GOOGLE_CLIENT_ID=xxx
GOOGLE_CLIENT_SECRET=xxx
GITHUB_CLIENT_ID=xxx
GITHUB_CLIENT_SECRET=xxx
```

#### Supabase

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx
SUPABASE_SERVICE_ROLE_KEY=eyJxxx
```

### 2. è·å– API å¯†é’¥

#### Clerk

1. è®¿é—® [Clerk Dashboard](https://dashboard.clerk.com)
2. åˆ›å»ºæ–°åº”ç”¨æˆ–é€‰æ‹©ç°æœ‰åº”ç”¨
3. åœ¨ "API Keys" é¡µé¢å¤åˆ¶å¯†é’¥
4. é…ç½®è®¤è¯è®¾ç½®å’Œç¤¾äº¤ç™»å½•

#### NextAuth

1. **Google**: è®¿é—® [Google Cloud Console](https://console.cloud.google.com)
2. **GitHub**: è®¿é—® [GitHub Developer Settings](https://github.com/settings/developers)
3. **Discord**: è®¿é—® [Discord Developer Portal](https://discord.com/developers/applications)

#### Supabase

1. è®¿é—® [Supabase Dashboard](https://supabase.com/dashboard)
2. åˆ›å»ºæ–°é¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®
3. åœ¨ "Settings > API" é¡µé¢å¤åˆ¶å¯†é’¥
4. é…ç½®è®¤è¯è®¾ç½®

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### Clerk é›†æˆç¤ºä¾‹

```tsx title="pages/_app.tsx"
import { ClerkProvider } from "@clerk/nextjs";

function MyApp({ Component, pageProps }) {
  return (
    <ClerkProvider>
      <Component {...pageProps} />
    </ClerkProvider>
  );
}

export default MyApp;
```

```tsx title="components/AuthButton.tsx"
import { SignInButton, SignOutButton, useUser } from "@clerk/nextjs";

export function AuthButton() {
  const { isSignedIn, user } = useUser();

  if (isSignedIn) {
    return (
      <div>
        <span>Hello, {user.firstName}!</span>
        <SignOutButton />
      </div>
    );
  }

  return <SignInButton />;
}
```

### NextAuth é›†æˆç¤ºä¾‹

```tsx title="pages/api/auth/[...nextauth].ts"
import NextAuth from "next-auth";
import GoogleProvider from "next-auth/providers/google";
import GitHubProvider from "next-auth/providers/github";

export default NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    GitHubProvider({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }),
  ],
});
```

```tsx title="components/AuthButton.tsx"
import { useSession, signIn, signOut } from "next-auth/react";

export function AuthButton() {
  const { data: session } = useSession();

  if (session) {
    return (
      <div>
        <span>Hello, {session.user?.name}!</span>
        <button onClick={() => signOut()}>é€€å‡ºç™»å½•</button>
      </div>
    );
  }

  return <button onClick={() => signIn()}>ç™»å½•</button>;
}
```

### Supabase é›†æˆç¤ºä¾‹

```tsx title="lib/supabase.ts"
import { createClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

```tsx title="components/AuthButton.tsx"
import { useState, useEffect } from "react";
import { supabase } from "../lib/supabase";

export function AuthButton() {
  const [user, setUser] = useState(null);

  useEffect(() => {
    const {
      data: { user },
    } = supabase.auth.getUser();
    setUser(user);

    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((event, session) => {
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, []);

  const handleSignIn = async () => {
    await supabase.auth.signInWithOAuth({
      provider: "google",
    });
  };

  const handleSignOut = async () => {
    await supabase.auth.signOut();
  };

  if (user) {
    return (
      <div>
        <span>Hello, {user.email}!</span>
        <button onClick={handleSignOut}>é€€å‡ºç™»å½•</button>
      </div>
    );
  }

  return <button onClick={handleSignIn}>ç™»å½•</button>;
}
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰è®¤è¯æµç¨‹

```tsx title="components/CustomAuth.tsx"
import { useState } from "react";
import { useAuth } from "../hooks/useAuth";

export function CustomAuth() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const { signIn, signUp, loading } = useAuth();

  const handleSignIn = async (e) => {
    e.preventDefault();
    await signIn(email, password);
  };

  const handleSignUp = async (e) => {
    e.preventDefault();
    await signUp(email, password);
  };

  return (
    <form>
      <input
        type="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        placeholder="é‚®ç®±"
      />
      <input
        type="password"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        placeholder="å¯†ç "
      />
      <button onClick={handleSignIn} disabled={loading}>
        ç™»å½•
      </button>
      <button onClick={handleSignUp} disabled={loading}>
        æ³¨å†Œ
      </button>
    </form>
  );
}
```

### æƒé™ç®¡ç†

```tsx title="components/ProtectedRoute.tsx"
import { useAuth } from "../hooks/useAuth";
import { useRouter } from "next/router";
import { useEffect } from "react";

interface ProtectedRouteProps {
  children: React.ReactNode;
  requiredRole?: string;
}

export function ProtectedRoute({
  children,
  requiredRole,
}: ProtectedRouteProps) {
  const { user, loading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!loading && !user) {
      router.push("/login");
    }

    if (requiredRole && user?.role !== requiredRole) {
      router.push("/unauthorized");
    }
  }, [user, loading, requiredRole, router]);

  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!user) {
    return null;
  }

  if (requiredRole && user.role !== requiredRole) {
    return <div>æƒé™ä¸è¶³</div>;
  }

  return <>{children}</>;
}
```

## ğŸ¨ è‡ªå®šä¹‰æ ·å¼

### Clerk æ ·å¼è‡ªå®šä¹‰

```tsx title="pages/_app.tsx"
import { ClerkProvider } from "@clerk/nextjs";

const clerkAppearance = {
  variables: {
    colorPrimary: "#3b82f6",
    colorText: "#1f2937",
    colorBackground: "#ffffff",
    colorInputBackground: "#f9fafb",
    colorInputText: "#1f2937",
    borderRadius: "8px",
  },
  elements: {
    formButtonPrimary: "bg-blue-600 hover:bg-blue-700",
    card: "shadow-lg",
  },
};

function MyApp({ Component, pageProps }) {
  return (
    <ClerkProvider appearance={clerkAppearance}>
      <Component {...pageProps} />
    </ClerkProvider>
  );
}
```

### NextAuth æ ·å¼è‡ªå®šä¹‰

```tsx title="pages/api/auth/[...nextauth].ts"
import NextAuth from "next-auth";

export default NextAuth({
  theme: {
    colorScheme: "light",
    brandColor: "#3b82f6",
    logo: "/logo.png",
  },
  pages: {
    signIn: "/auth/signin",
    signUp: "/auth/signup",
    error: "/auth/error",
  },
});
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. è®¤è¯çŠ¶æ€ä¸åŒæ­¥

**é—®é¢˜**: ç”¨æˆ·ç™»å½•åçŠ¶æ€æ²¡æœ‰æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**:

```tsx
// ç¡®ä¿åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨è®¤è¯é’©å­
const { user, loading } = useAuth();

// æˆ–è€…æ‰‹åŠ¨åˆ·æ–°çŠ¶æ€
const refreshAuth = async () => {
  await supabase.auth.getSession();
};
```

### 2. é‡å®šå‘é—®é¢˜

**é—®é¢˜**: ç™»å½•åæ²¡æœ‰æ­£ç¡®é‡å®šå‘

**è§£å†³æ–¹æ¡ˆ**:

```tsx
// è®¾ç½®æ­£ç¡®çš„å›è°ƒ URL
const handleSignIn = async () => {
  await signIn("google", {
    callbackUrl: "/dashboard",
  });
};
```

### 3. ç¯å¢ƒå˜é‡é—®é¢˜

**é—®é¢˜**: API å¯†é’¥é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY

# é‡å¯å¼€å‘æœåŠ¡å™¨
npm run dev
```

## ğŸ“š æœ€ä½³å®è·µ

1. **å®‰å…¨æ€§**: å§‹ç»ˆä½¿ç”¨ HTTPSï¼Œä¿æŠ¤æ•æ„Ÿä¿¡æ¯
2. **ç”¨æˆ·ä½“éªŒ**: æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’ŒåŠ è½½çŠ¶æ€
3. **æ€§èƒ½**: ä½¿ç”¨é€‚å½“çš„ç¼“å­˜ç­–ç•¥
4. **å¯è®¿é—®æ€§**: ç¡®ä¿è®¤è¯ç•Œé¢ç¬¦åˆæ— éšœç¢æ ‡å‡†
5. **æµ‹è¯•**: ç¼–å†™è®¤è¯æµç¨‹çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## ğŸ¯ ä¸‹ä¸€æ­¥

å®Œæˆè®¤è¯é›†æˆåï¼Œä½ å¯ä»¥ï¼š

- [æ·»åŠ æ”¯ä»˜ç³»ç»Ÿ](./payments) - ä¸ºåº”ç”¨æ·»åŠ ä»˜è´¹åŠŸèƒ½
- [é…ç½®æ•°æ®åº“](./database) - å­˜å‚¨ç”¨æˆ·æ•°æ®
- [è®¾ç½®é‚®ä»¶æœåŠ¡](./email) - å‘é€è®¤è¯é‚®ä»¶- [æ·»åŠ ç”¨æˆ·ç®¡ç†](./user-management) - ç®¡ç†ç”¨æˆ·è´¦æˆ·
